<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试本地存储持久化</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>CodeCA 本地存储持久化测试</h1>
    
    <div class="test-section">
        <h2>1. 模拟卡片数据存储</h2>
        <button onclick="saveTestData()">保存测试卡片数据</button>
        <button onclick="loadTestData()">加载存储的数据</button>
        <button onclick="clearTestData()">清除存储数据</button>
        <div id="storage-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 查看当前存储内容</h2>
        <button onclick="viewStorageContent()">查看localStorage内容</button>
        <div id="content-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 测试Date对象序列化</h2>
        <button onclick="testDateSerialization()">测试Date序列化</button>
        <div id="date-result" class="result"></div>
    </div>

    <script>
        const STORAGE_KEY = 'codeca-app-storage';
        
        // 模拟卡片数据
        const testCards = [
            {
                id: '1',
                front: '什么是React？',
                back: 'React是一个用于构建用户界面的JavaScript库',
                type: 'basic',
                difficulty: 'medium',
                tags: ['react', 'javascript'],
                createdAt: new Date()
            },
            {
                id: '2',
                front: 'CSS Grid的作用是什么？',
                back: 'CSS Grid是一个二维布局系统，用于创建复杂的网页布局',
                type: 'definition',
                difficulty: 'hard',
                tags: ['css', 'layout'],
                createdAt: new Date()
            }
        ];
        
        function saveTestData() {
            const storeData = {
                state: {
                    cards: testCards,
                    bucketCards: ['1'],
                    locale: 'zh-CN',
                    selectedProvider: 'openai',
                    isBucketVisible: true
                },
                version: 1
            };
            
            // 模拟Zustand persist的存储逻辑
            const serializedData = {
                ...storeData,
                state: {
                    ...storeData.state,
                    cards: storeData.state.cards.map(card => ({
                        ...card,
                        createdAt: card.createdAt.toISOString()
                    }))
                }
            };
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(serializedData));
            
            document.getElementById('storage-result').textContent = 
                '✅ 测试数据已保存到localStorage\n' +
                `保存了 ${testCards.length} 张卡片\n` +
                `存储大小: ${JSON.stringify(serializedData).length} 字符`;
        }
        
        function loadTestData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) {
                document.getElementById('storage-result').textContent = '❌ 没有找到存储的数据';
                return;
            }
            
            try {
                const parsed = JSON.parse(stored);
                
                // 模拟反序列化Date对象
                if (parsed.state?.cards) {
                    parsed.state.cards = parsed.state.cards.map(card => ({
                        ...card,
                        createdAt: new Date(card.createdAt)
                    }));
                }
                
                document.getElementById('storage-result').textContent = 
                    '✅ 数据加载成功\n' +
                    `卡片数量: ${parsed.state.cards?.length || 0}\n` +
                    `桶中卡片: ${parsed.state.bucketCards?.length || 0}\n` +
                    `语言设置: ${parsed.state.locale}\n` +
                    `选中的AI: ${parsed.state.selectedProvider}\n` +
                    `第一张卡片创建时间: ${parsed.state.cards?.[0]?.createdAt}`;
                    
            } catch (error) {
                document.getElementById('storage-result').textContent = 
                    '❌ 数据解析失败: ' + error.message;
            }
        }
        
        function clearTestData() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('storage-result').textContent = '🗑️ 存储数据已清除';
        }
        
        function viewStorageContent() {
            const allKeys = Object.keys(localStorage);
            const codecaKeys = allKeys.filter(key => key.includes('codeca'));
            
            let result = `localStorage中的所有键 (${allKeys.length}):\n`;
            result += allKeys.join(', ') + '\n\n';
            
            result += `CodeCA相关的键 (${codecaKeys.length}):\n`;
            codecaKeys.forEach(key => {
                const value = localStorage.getItem(key);
                result += `${key}: ${value ? value.length + ' 字符' : 'null'}\n`;
            });
            
            if (codecaKeys.length > 0) {
                result += '\n详细内容:\n';
                codecaKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    result += `\n${key}:\n${value}\n`;
                });
            }
            
            document.getElementById('content-result').textContent = result;
        }
        
        function testDateSerialization() {
            const testDate = new Date();
            const serialized = testDate.toISOString();
            const deserialized = new Date(serialized);
            
            const result = 
                `原始Date: ${testDate}\n` +
                `序列化后: ${serialized}\n` +
                `反序列化: ${deserialized}\n` +
                `是否相等: ${testDate.getTime() === deserialized.getTime() ? '✅' : '❌'}\n` +
                `时间差: ${Math.abs(testDate.getTime() - deserialized.getTime())}ms`;
                
            document.getElementById('date-result').textContent = result;
        }
        
        // 页面加载时自动检查存储状态
        window.onload = function() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                document.getElementById('storage-result').textContent = 
                    '📦 发现已存储的数据，点击"加载存储的数据"查看详情';
            } else {
                document.getElementById('storage-result').textContent = 
                    '📭 暂无存储数据，点击"保存测试卡片数据"开始测试';
            }
        };
    </script>
</body>
</html>